[{"name":"app.R","content":"#| standalone: true\r\n#| packages: [ \"shiny\", \"shinydashboard\", \"genpwr\", \"munsell\", \"scales\", \"tibble\", \"dplyr\", \"rlang\" ]\r\nlibrary(shiny)\r\nlibrary(shinydashboard)\r\n\r\n# Truco para forzar que el navegador descargue munsell antes de usar genpwr\r\nif (FALSE) {\r\n  library(munsell)\r\n  library(scales)\r\n}\r\n\r\nlibrary(genpwr)\r\n\r\n# Interfaz de Usuario (UI)\r\nui <- dashboardPage(\r\n  skin = \"blue\",\r\n  \r\n  dashboardHeader(title = \"Calculadora GWAS\"),\r\n  \r\n  dashboardSidebar(\r\n    sidebarMenu(\r\n      menuItem(\"Calculadora\", tabName = \"calc\", icon = icon(\"calculator\")),\r\n      menuItem(\"Información\", tabName = \"info\", icon = icon(\"info-circle\"))\r\n    ),\r\n    \r\n    hr(),\r\n    h4(\" Parámetros\", style = \"margin-left: 15px;\"),\r\n    \r\n    selectInput(\"tipo_calculo\", \"Cálculo deseado:\",\r\n                choices = c(\"Tamaño Muestral (N)\" = \"n\", \r\n                            \"Potencia Estadística\" = \"power\")),\r\n    \r\n    selectInput(\"model\", \"Modelo del Test:\",\r\n                choices = c(\"Aditivo\" = \"Additive\", \r\n                            \"Dominante\" = \"Dominant\", \r\n                            \"Recesivo\" = \"Recessive\")),\r\n    \r\n    sliderInput(\"maf\", \"MAF (Frec. Alelo Menor):\", 0.01, 0.5, 0.1, 0.01),\r\n    sliderInput(\"or\", \"Odds Ratio (Efecto):\", 1.05, 3.0, 1.25, 0.05),\r\n    numericInput(\"alpha\", \"Significancia (Alpha):\", value = 5e-8),\r\n    \r\n    conditionalPanel(\r\n      condition = \"input.tipo_calculo == 'n'\",\r\n      sliderInput(\"target_power\", \"Potencia deseada:\", 0.5, 0.95, 0.8, 0.05)\r\n    ),\r\n    \r\n    conditionalPanel(\r\n      condition = \"input.tipo_calculo == 'power'\",\r\n      numericInput(\"target_n\", \"N total disponible:\", value = 1000, min = 1)\r\n    )\r\n  ),\r\n  \r\n  dashboardBody(\r\n    tabItems(\r\n      # Pestaña Principal\r\n      tabItem(tabName = \"calc\",\r\n              fluidRow(\r\n                # Caja de Resultados - Usamos shinydashboard::box para evitar conflictos\r\n                shinydashboard::box(\r\n                  title = \"Resultados del Análisis\", \r\n                  status = \"primary\", \r\n                  solidHeader = TRUE, \r\n                  width = 8,\r\n                  helpText(\"Asumiendo ratio casos/controles = 1 (k=1)\"),\r\n                  uiOutput(\"resultadoText\")\r\n                ),\r\n                \r\n                # Caja de ayuda rápida\r\n                shinydashboard::box(\r\n                  title = \"Guía rápida\", \r\n                  status = \"warning\", \r\n                  width = 4,\r\n                  \"Modifica los parámetros de la izquierda para ver cómo impactan en el tamaño de muestra o la potencia.\"\r\n                )\r\n              )\r\n      ),\r\n      \r\n      # Pestaña de Información\r\n      tabItem(tabName = \"info\",\r\n              h2(\"Sobre esta herramienta\"),\r\n              p(\"Esta calculadora utiliza el paquete 'genpwr' para estimar la potencia y el tamaño de muestra en estudios de asociación genómica (GWAS).\")\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# Servidor\r\nserver <- function(input, output) {\r\n  \r\n  output$resultadoText <- renderUI({\r\n    req(input$model, input$maf, input$or, input$alpha)\r\n    \r\n    res <- tryCatch({\r\n      if (input$tipo_calculo == \"n\") {\r\n        genpwr::ss.calc(\r\n          OR = as.numeric(input$or), k = 1,\r\n          MAF = as.numeric(input$maf), Alpha = as.numeric(input$alpha),\r\n          power = as.numeric(input$target_power), Test.Model = input$model\r\n        )\r\n      } else {\r\n        genpwr::power.calc(\r\n          OR = as.numeric(input$or), k = 1,\r\n          N = as.numeric(input$target_n),\r\n          MAF = as.numeric(input$maf), Alpha = as.numeric(input$alpha),\r\n          Test.Model = input$model\r\n        )\r\n      }\r\n    }, error = function(e) return(NULL))\r\n    \r\n    if(is.null(res)) return(HTML(\"<b style='color:red'>Error en el cálculo. Revisa los parámetros.<\/b>\"))\r\n    \r\n    get_val <- function(modelo_real) {\r\n      fila <- which(tolower(res$True.Model) == tolower(modelo_real))\r\n      if(length(fila) == 0) return(\"N/A\")\r\n      \r\n      if (input$tipo_calculo == \"n\") {\r\n        valor <- res$N_total[fila]\r\n        return(paste0(\"<span class='label label-success' style='font-size:14px'>\", format(round(valor), big.mark = \".\", decimal.mark = \",\"), \" individuos<\/span>\"))\r\n      } else {\r\n        valor <- res$Power[fila]\r\n        return(paste0(\"<span class='label label-info' style='font-size:14px'>\", round(valor * 100, 2), \"% de potencia<\/span>\"))\r\n      }\r\n    }\r\n    \r\n    HTML(paste0(\r\n      \"<div style='font-size: 16px; line-height: 2.5;'>\",\r\n      \"<p>Resultados según la arquitectura genética verdadera:<\/p>\",\r\n      \"<b>Modelo Aditivo:<\/b> \", get_val(\"Additive\"), \"<br>\",\r\n      \"<b>Modelo Dominante:<\/b> \", get_val(\"Dominant\"), \"<br>\",\r\n      \"<b>Modelo Recesivo:<\/b> \", get_val(\"Recessive\"),\r\n      \"<\/div>\"\r\n    ))\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"},{"name":"Prueba/app.R","content":[],"type":"text"}]
