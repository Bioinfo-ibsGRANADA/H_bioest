[{"name":"app.R","content":"#| standalone: true\r\n#| packages: [ \"shiny\", \"bslib\", \"genpwr\", \"ggplot2\", \"nleqslv\", \"MASS\", \"cli\", \"gtable\", \"isoband\", \"lifecycle\", \"rlang\", \"S7\", \"scales\", \"vctrs\", \"withr\", \"glue\", \"cpp11\", \"farver\", \"labeling\", \"R6\", \"RColorBrewer\", \"viridisLite\", \"munsell\" ]\r\n\r\nlibrary(shiny)\r\nlibrary(bslib)\r\nlibrary(genpwr)\r\n\r\nui <- page_sidebar(\r\n  title = \"Calculadora de Potencia Genómica\",\r\n  theme = bs_theme(bootswatch = \"flatly\"),\r\n  \r\n  sidebar = sidebar(\r\n    h5(\"Selección de Método\"),\r\n    selectInput(\"metodo\", \"Tipo de estudio:\",\r\n                choices = c(\"GWAS (Genómica de Asociación)\" = \"gwas\",\r\n                            \"RNA-Seq (Expresión Génica)\" = \"rnaseq\")),\r\n    hr(),\r\n    h5(\"Parámetros\"),\r\n    \r\n    # Parámetros GWAS\r\n    conditionalPanel(\r\n      condition = \"input.metodo == 'gwas'\",\r\n      selectInput(\"tipo_calculo\", \"Cálculo deseado:\",\r\n                  choices = c(\"Tamaño Muestral (N)\" = \"n\",\r\n                              \"Potencia Estadística\" = \"power\")),\r\n      selectInput(\"model\", \"Modelo del Test:\",\r\n                  choices = c(\"Aditivo\" = \"Additive\",\r\n                              \"Dominante\" = \"Dominant\",\r\n                              \"Recesivo\" = \"Recessive\")),\r\n      sliderInput(\"maf\", \"MAF (Frec. Alelo Menor):\", 0.01, 0.5, 0.1, 0.01),\r\n      sliderInput(\"or\", \"Odds Ratio (Efecto):\", 1.05, 3.0, 1.25, 0.05),\r\n      numericInput(\"alpha_gwas\", \"Significancia (Alpha):\", value = 5e-8),\r\n      conditionalPanel(\r\n        condition = \"input.tipo_calculo == 'n'\",\r\n        sliderInput(\"target_power\", \"Potencia deseada:\", 0.5, 0.95, 0.8, 0.05)\r\n      ),\r\n      conditionalPanel(\r\n        condition = \"input.tipo_calculo == 'power'\",\r\n        numericInput(\"target_n\", \"N total disponible:\", value = 1000, min = 1)\r\n      )\r\n    ),\r\n    \r\n    # Parámetros RNA-Seq\r\n    conditionalPanel(\r\n      condition = \"input.metodo == 'rnaseq'\",\r\n      numericInput(\"depth\", \"Profundidad de Lectura (Depth):\", value = 100, min = 1),\r\n      helpText(\"Promedio de lecturas por gen.\"),\r\n      numericInput(\"cv\", \"Coeficiente de Variación (CV):\", value = 0.7, min = 0.01, max = 1, step = 0.1),\r\n      helpText(\"Variabilidad biológica (0.4 - 0.7 es común en humanos).\"),\r\n      numericInput(\"effect\", \"Tamaño del Efecto (Fold Change):\", value = 1.25, min = 1.0, step = 0.05),\r\n      helpText(\"Ej: 1.25 significa un cambio del 25%.\"),\r\n      numericInput(\"power_rna\", \"Potencia deseada:\", value = 0.8, min = 0.1, max = 0.99, step = 0.05),\r\n      numericInput(\"alpha_rna\", \"Nivel de Significancia (Alpha):\", value = 0.05, min = 0.001, max = 0.1, step = 0.01),\r\n      actionButton(\"btn_calcular\", \"CALCULAR\", class = \"btn-primary\", style = \"width: 100%;\")\r\n    )\r\n  ),\r\n  \r\n  navset_tab(\r\n    nav_panel(\"Calculadora\",\r\n      uiOutput(\"panel_calculadora\")\r\n    ),\r\n    nav_panel(\"Información\",\r\n      card(card_body(\r\n        h3(\"Sobre esta herramienta\"),\r\n        p(\"Esta aplicación combina dos calculadoras de potencia estadística para estudios genómicos:\"),\r\n        tags$ul(\r\n          tags$li(strong(\"GWAS:\"), \" Usa el paquete 'genpwr' para estudios de asociación genómica.\"),\r\n          tags$li(strong(\"RNA-Seq:\"), \" Cálculo basado en distribución Binomial Negativa, equivalente a RNASeqPower.\")\r\n        )\r\n      ))\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output) {\r\n  \r\n  # --- GWAS reactivo (se actualiza solo) ---\r\n  resultado_gwas <- reactive({\r\n    req(input$metodo == \"gwas\", input$model, input$maf, input$or, input$alpha_gwas)\r\n    tryCatch({\r\n      if (input$tipo_calculo == \"n\") {\r\n        genpwr::ss.calc(\r\n          OR = as.numeric(input$or), k = 1,\r\n          MAF = as.numeric(input$maf), Alpha = as.numeric(input$alpha_gwas),\r\n          power = as.numeric(input$target_power), Test.Model = input$model\r\n        )\r\n      } else {\r\n        genpwr::power.calc(\r\n          OR = as.numeric(input$or), k = 1,\r\n          N = as.numeric(input$target_n),\r\n          MAF = as.numeric(input$maf), Alpha = as.numeric(input$alpha_gwas),\r\n          Test.Model = input$model\r\n        )\r\n      }\r\n    }, error = function(e) return(NULL))\r\n  })\r\n  \r\n  # --- RNA-Seq reactivo (solo al pulsar botón) ---\r\n  resultado_rna <- eventReactive(input$btn_calcular, {\r\n    req(input$depth, input$cv, input$effect, input$alpha_rna, input$power_rna)\r\n    tryCatch({\r\n      z_alpha <- qnorm(1 - input$alpha_rna / 2)\r\n      z_beta  <- qnorm(input$power_rna)\r\n      n <- ((z_alpha + z_beta)^2 * (1/input$depth + input$cv^2)) / (log(input$effect)^2)\r\n      ceiling(n)\r\n    }, error = function(e) return(NULL))\r\n  })\r\n  \r\n  # --- Panel principal que cambia según el método ---\r\n  output$panel_calculadora <- renderUI({\r\n    \r\n    if (input$metodo == \"gwas\") {\r\n      \r\n      res <- resultado_gwas()\r\n      \r\n      if (is.null(res)) {\r\n        return(card(card_body(HTML(\"<b style='color:red'>Error en el cálculo. Revisa los parámetros.<\/b>\"))))\r\n      }\r\n      \r\n      get_val <- function(modelo_real) {\r\n        fila <- which(tolower(res$True.Model) == tolower(modelo_real))\r\n        if (length(fila) == 0) return(\"N/A\")\r\n        if (input$tipo_calculo == \"n\") {\r\n          valor <- res$N_total[fila]\r\n          return(paste0(\"<span class='badge bg-success' style='font-size:14px'>\",\r\n                        format(round(valor), big.mark=\".\", decimal.mark=\",\"),\r\n                        \" individuos<\/span>\"))\r\n        } else {\r\n          valor <- res$Power[fila]\r\n          return(paste0(\"<span class='badge bg-primary' style='font-size:14px'>\",\r\n                        round(valor*100, 2), \"% de potencia<\/span>\"))\r\n        }\r\n      }\r\n      \r\n      layout_columns(\r\n        col_widths = c(8, 4),\r\n        card(\r\n          card_header(\"Resultados GWAS\"),\r\n          card_body(\r\n            helpText(\"Asumiendo ratio casos/controles = 1 (k=1)\"),\r\n            HTML(paste0(\r\n              \"<div style='font-size:16px; line-height:2.5;'>\",\r\n              \"<p>Resultados según la arquitectura genética verdadera:<\/p>\",\r\n              \"<b>Modelo Aditivo:<\/b> \", get_val(\"Additive\"), \"<br>\",\r\n              \"<b>Modelo Dominante:<\/b> \", get_val(\"Dominant\"), \"<br>\",\r\n              \"<b>Modelo Recesivo:<\/b> \", get_val(\"Recessive\"),\r\n              \"<\/div>\"\r\n            ))\r\n          )\r\n        ),\r\n        card(\r\n          card_header(\"Guía rápida\"),\r\n          card_body(p(\"Modifica los parámetros de la izquierda para ver cómo impactan en el tamaño de muestra o la potencia.\"))\r\n        )\r\n      )\r\n      \r\n    } else {\r\n      \r\n      # Panel RNA-Seq\r\n      val <- if (input$btn_calcular > 0) resultado_rna() else NULL\r\n      \r\n      layout_columns(\r\n        col_widths = c(8, 4),\r\n        card(\r\n          card_header(\"Resultados RNA-Seq\"),\r\n          card_body(\r\n            if (is.null(val)) {\r\n              h5(\"Introduce los datos y pulsa CALCULAR.\")\r\n            } else {\r\n              div(style = \"background-color:#f7f7f9; padding:20px; border-radius:10px; border:1px solid #e1e1e8;\",\r\n                  h4(\"Tamaño muestral requerido:\"),\r\n                  h1(paste(val, \"sujetos por grupo\"), style = \"color:#2c3e50; font-weight:bold;\"),\r\n                  h3(paste(\"Total del estudio:\", val * 2, \"sujetos\"), style = \"color:#e74c3c;\")\r\n              )\r\n            }\r\n          )\r\n        ),\r\n        card(\r\n          card_header(\"Guía rápida\"),\r\n          card_body(\r\n            tags$ul(\r\n              tags$li(strong(\"n por grupo:\"), \" Pacientes necesarios en cada brazo del estudio.\"),\r\n              tags$li(strong(\"Total:\"), \" Suma de los dos grupos.\"),\r\n              tags$li(\"Cálculo basado en distribución Binomial Negativa (estándar para RNA-Seq).\")\r\n            )\r\n          )\r\n        )\r\n      )\r\n    }\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"}]
